name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - test

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
          - os: macos-latest
            platform: macos
            arch: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'

    - name: Install PDM
      uses: pdm-project/setup-pdm@v3
      with:
        python-version: '3.14'

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f'VERSION={version}')
        " >> $GITHUB_OUTPUT
      shell: bash

    - name: Install dependencies
      run: |
        pdm install --prod

    - name: Build executable using platform-specific script (Windows)
      if: matrix.platform == 'windows'
      run: |
        .\build_windows.bat --no-verify
      shell: cmd

    - name: Build executable using platform-specific script (Unix)
      if: matrix.platform != 'windows'
      run: |
        if [ "${{ matrix.platform }}" = "macos" ]; then
          chmod +x ./build_mac.sh
          ./build_mac.sh --no-test --no-dmg
        else
          chmod +x ./build_linux.sh
          ./build_linux.sh --no-verify
        fi
      shell: bash

    - name: Rename executable
      run: |
        cd dist
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        if [ "$BUILD_TYPE" = "test" ]; then
          SUFFIX="-test-$(date +%Y%m%d-%H%M%S)"
        else
          SUFFIX=""
        fi
        
        if [ "${{ matrix.platform }}" = "windows" ]; then
          if [ -f "redis-ttk.exe" ]; then
            mv redis-ttk.exe redis-ttk-${{ steps.get_version.outputs.VERSION }}${SUFFIX}-${{ matrix.platform }}-${{ matrix.arch }}.exe
          else
            echo "Error: redis-ttk.exe not found for renaming"
            exit 1
          fi
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          if [ -d "Redis-TTK.app" ]; then
            # For macOS app bundle, create a zip archive
            zip -r redis-ttk-${{ steps.get_version.outputs.VERSION }}${SUFFIX}-${{ matrix.platform }}-${{ matrix.arch }}.zip Redis-TTK.app
            rm -rf Redis-TTK.app
          elif [ -f "Redis-TTK" ]; then
            # For standalone executable
            mv Redis-TTK redis-ttk-${{ steps.get_version.outputs.VERSION }}${SUFFIX}-${{ matrix.platform }}-${{ matrix.arch }}
          else
            echo "Error: Neither Redis-TTK.app nor Redis-TTK found for renaming"
            exit 1
          fi
        else
          if [ -f "Redis-TTK" ]; then
            mv Redis-TTK redis-ttk-${{ steps.get_version.outputs.VERSION }}${SUFFIX}-${{ matrix.platform }}-${{ matrix.arch }}
          else
            echo "Error: Redis-TTK not found for renaming"
            exit 1
          fi
        fi
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: redis-ttk-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          dist/redis-ttk-*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && (github.event.inputs.build_type != 'test' || github.event.inputs.build_type == '')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f'VERSION={version}')
        " >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Redis-TTK v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          redis-ttk-*/redis-ttk-*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-build:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'test'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f'VERSION={version}')
        " >> $GITHUB_OUTPUT

    - name: Upload test build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: redis-ttk-test-build-${{ steps.get_version.outputs.VERSION }}
        path: |
          redis-ttk-*/redis-ttk-*
        retention-days: 7
