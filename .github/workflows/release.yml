name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - test

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
          - os: macos-latest
            platform: macos
            arch: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'

    - name: Install PDM
      uses: pdm-project/setup-pdm@v3
      with:
        python-version: '3.14'

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f'VERSION={version}')
        " >> $GITHUB_OUTPUT
      shell: bash

    - name: Install dependencies
      run: |
        pdm install --prod
        pdm add pyinstaller

    - name: Create build script
      run: |
        cat > build_script.py << 'EOF'
        import PyInstaller.__main__
        import sys
        import os

        # Get platform-specific settings
        platform = "${{ matrix.platform }}"

        args = [
            'main.py',
            '--onefile',
            '--windowed',
            '--name=redis-ttk',
            '--add-data=config:config',
            '--add-data=gui:gui',
            '--hidden-import=ttkbootstrap',
            '--hidden-import=redis',
            '--hidden-import=tkinter',
            '--hidden-import=tkinter.ttk',
            '--hidden-import=PIL',
            '--hidden-import=PIL._tkinter_finder',
            '--collect-all=ttkbootstrap',
            '--collect-submodules=ttkbootstrap',
            '--collect-submodules=redis',
            '--clean',
            '--noconfirm',
            '--noupx',
        ]

        # Platform-specific optimizations
        if platform == "macos":
            args.extend([
                '--osx-bundle-identifier=com.redis-ttk.app',
                '--target-arch=arm64',
                '--codesign-identity=-',
            ])
        elif platform == "linux":
            args.extend([
                '--strip',
            ])
        elif platform == "windows":
            args.extend([
                '--uac-admin',
            ])

        PyInstaller.__main__.run(args)
        EOF
      shell: bash

    - name: Build executable
      run: |
        pdm run python build_script.py

    - name: Set executable permissions and sign (macOS/Linux)
      if: matrix.platform != 'windows'
      run: |
        chmod +x dist/redis-ttk
        if [ "${{ matrix.platform }}" = "macos" ]; then
          # Remove quarantine attribute and sign the executable
          xattr -d com.apple.quarantine dist/redis-ttk || true
          codesign --force --deep --sign - dist/redis-ttk || echo "Code signing failed, but continuing"
        fi

    - name: Verify executable
      run: |
        cd dist
        if [ "${{ matrix.platform }}" = "windows" ]; then
          file redis-ttk.exe || echo "File command not available on Windows"
          ls -la redis-ttk.exe
          echo "Windows executable verified"
        else
          file redis-ttk
          ls -la redis-ttk
          # Check if the executable is valid
          if [ -f redis-ttk ]; then
            echo "Executable exists and has size: $(stat -f%z redis-ttk 2>/dev/null || stat -c%s redis-ttk 2>/dev/null || echo 'unknown') bytes"
            # Verify it's a valid Mach-O executable on macOS
            if [ "${{ matrix.platform }}" = "macos" ]; then
              otool -h redis-ttk >/dev/null 2>&1 && echo "Valid Mach-O executable" || echo "Warning: Not a valid Mach-O executable"
            fi
          else
            echo "Error: Executable not found!"
            exit 1
          fi
          echo "Executable file verified - skipping GUI test in headless environment"
        fi
      shell: bash

    - name: Rename executable
      run: |
        cd dist
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        if [ "$BUILD_TYPE" = "test" ]; then
          SUFFIX="-test-$(date +%Y%m%d-%H%M%S)"
        else
          SUFFIX=""
        fi
        
        if [ "${{ matrix.platform }}" = "windows" ]; then
          mv redis-ttk.exe redis-ttk-${{ steps.get_version.outputs.VERSION }}${SUFFIX}-${{ matrix.platform }}-${{ matrix.arch }}.exe
        else
          mv redis-ttk redis-ttk-${{ steps.get_version.outputs.VERSION }}${SUFFIX}-${{ matrix.platform }}-${{ matrix.arch }}
        fi
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: redis-ttk-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          dist/redis-ttk-*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && (github.event.inputs.build_type != 'test' || github.event.inputs.build_type == '')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f'VERSION={version}')
        " >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Redis-TTK v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          redis-ttk-*/redis-ttk-*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-build:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'test'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f'VERSION={version}')
        " >> $GITHUB_OUTPUT

    - name: Upload test build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: redis-ttk-test-build-${{ steps.get_version.outputs.VERSION }}
        path: |
          redis-ttk-*/redis-ttk-*
        retention-days: 7
